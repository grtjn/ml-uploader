!function(){"use strict";angular.module("ml.uploader",["ml.common","ui.bootstrap"])}(),function(){"use strict";function MLUploadService($rootScope,mlRest,$http){function applyUpdate(){$rootScope.$$phase||$rootScope.$apply()}function processFile(f,scope){console.log("processing file",f);var ext=f.name.substr(f.name.lastIndexOf(".")+1),docOptions=angular.extend({category:"content"},scope.uploadOptions);scope.transform&&(docOptions.transform=scope.transform),scope.collection&&(docOptions.collection=scope.collection);var progress=service.sendFile(f,docOptions,scope.onSend,scope.onSendDone,scope.onSendFail);progress.ext=ext,scope.files.push(progress)}var service={},Progress={};return Progress.value=0,Progress.done=!1,Progress.name="unkown",Progress.failed=!1,Progress.update=function(val){this.updated=Date.now(),console.log("update progress",this),val&&(this.value=val,this.done=100===val),applyUpdate(this)},Progress.error=function(code){console.log("setting error",code),this.failed=!0,this.errorStatus=code,applyUpdate(this)},service.sendFile=function(data,opts,onSend,onSendDone,onSendFail){var progress=Object.create(Progress),format="binary";progress.name=data.name,console.log("sending file"),/text/.test(data.type)?format="text":/xml/.test(data.type)?format="xml":/json/.test(data.type)&&(format="json");var uri=data.name.replace(/[^!*'();:@&=+$,\/?#\[\]A-Za-z0-9\-_.~%]/g,"_");opts&&opts.uriPrefix&&(uri=angular.isFunction(opts.uriPrefix)?opts.uriPrefix(data)+uri:opts.uriPrefix+uri);var params=angular.extend(opts,{uri:uri,format:format});return delete params.uriPrefix,onSend&&onSend(progress),mlRest.request("/documents",{data:data,params:params,method:"PUT",headers:{"Content-Type":data.type}}).then(function(response){console.log("added document to grade"),onSendDone&&onSendDone(progress),progress.done=!0,progress.update(100)},function(reason){console.log("send document failed:"+reason),progress.failed=!0,onSendFail&&onSendFail(progress)}),progress.uri=uri,progress.type=data.type,progress},service.dzHighlight=function(e,dropzone){e.stopPropagation(),e.preventDefault(),"dragenter"===e.type||"dragover"===e.type?dropzone.addClass("hover"):dropzone.removeClass("hover")},service.dropFiles=function(e,dropzone,scope){e.preventDefault(),e.stopPropagation(),e=e.originalEvent;var files=e.target.files||e.dataTransfer.files,i=files.length;for(service.dzHighlight(e,dropzone);i--;)processFile(files[i],scope);scope.$apply()},service}angular.module("ml.uploader").factory("mlUploadService",MLUploadService),MLUploadService.$inject=["$rootScope","MLRest","$http"]}(),function(){"use strict";function isSupported(){return window.File&&window.FileList&&window.FileReader}function MLUploadDirective(mlUploadService){return{restrict:"E",replace:!0,transclude:!0,scope:{button:"@",multiple:"@",collection:"@mlCollection",fileList:"=uploadFileList",transform:"=mlTransform",uploadOptions:"=",onSend:"=",onSendDone:"=",onSendFail:"=",doubleClick:"="},link:function(scope,ele,attr,transclude){if(scope.files=scope.fileList||[],scope.uploadOptions=scope.uploadOptions||{},!isSupported())throw"ml-uloader - HTML5 file upload not supported by this browser";scope.multiple=scope.multiple&&"true"===scope.multiple,ele=angular.element(ele),ele.append('<div style="width:0;height:0;overflow:hidden"><input type="file" name="_hidden_uploader_file" '+(scope.multiple?"multiple":"")+"></div>");var doubleclick,fileInp=ele.find('input[type="file"]'),dropzone=ele.find(".ml-dropzone");scope.open=function(){console.log("button click"),fileInp[0].value="",fileInp[0].click()},dropzone.on("click",function(evt){doubleclick=!1,window.setTimeout(function(){doubleclick||(console.log("dz click"),fileInp[0].value="",fileInp.click())},300),evt.stopPropagation()}).on("dblclick",function(evt){doubleclick=!0,console.log("dz dblclick");var name=evt.target.title||evt.target.textContent,file=scope.files.filter(function(f){return f.name===name})[0];scope.doubleClick&&scope.doubleClick(file),evt.stopPropagation()}).on("drop",function(e){return mlUploadService.dropFiles(e,dropzone,scope)}).on("dragenter dragleave dragover",function(e){return mlUploadService.dzHighlight(e,dropzone)}),fileInp.on("change",function(e){return mlUploadService.dropFiles(e,dropzone,scope)}),jQuery("html").on("drop",function(e){return e.preventDefault(),console.log("document drop",e),!1})},template:function(ele,attr){return"true"===attr.button?'<div class="ml-upload"><button class="btn btn-default" ng-click="open()">Upload file'+("true"===attr.multiple?"(s)":"")+"</button></div>":'<div class="ml-upload"><div class="ml-dropzone"><div class="notes" ng-transclude ng-hide="files.length"></div><ul class="ml-upload-file-list list-unstyled" ng-show="files.length"><li ng-repeat="f in files" class="ml-upload-file"  ng-attr-file-extension="{{f.ext}}"  ng-class="{ \'ml-upload-done\': f.done, \'ml-upload-error\': f.failed }"  ng-attr-title="{{f.errorStatus || f.name}}"><span class="ml-upload-file-name">{{ f.name }}</span><span class="ml-upload-file-progress"><span class="ml-upload-progress-value">{{ f.value }}%</span><span class="ml-upload-progress-bar"  ng-style="{ width: f.value + \'%\' }">&nbsp;</span></span></li></ul></div></div>'}}}MLUploadDirective.$inject=["mlUploadService"],angular.module("ml.uploader").directive("mlUpload",MLUploadDirective)}();